var tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),color=d3.scale.linear().domain([0,13]).range([d3.rgb("yellow"),d3.rgb("red")]);mapboxgl.accessToken="pk.eyJ1IjoiZmVuZ21hcHRlc3QiLCJhIjoiY2pxcm12ZDdwMG90cjQ4cWpubWhxbzhzeCJ9.vv5TwlIjyI9zDhRu3gZBSA";var map=new mapboxgl.Map({container:"map",style:"mapbox://styles/fengmaptest/ck75rws9e32041ip3cmlwhkhs/draft",center:[126.978,37.5665],zoom:8});const bb=map.getCanvasContainer();var svg=d3.select(map.getCanvasContainer()).append("svg").style("position","absolute").style("top",0).style("left",0).attr("width",bb.width).attr("height",bb.height),gs=svg.append("g");function projectPoint(t,o){var n=map.project(new mapboxgl.LngLat(t,o));this.stream.point(n.x,n.y)}function add_hospital(){var t={},o={};person_info.forEach(function(n,e){n.hloc in t?t[n.hloc][1]++:(t[n.hloc]=[],t[n.hloc].push(new mapboxgl.LngLat(n.hlng,n.hlat)),t[n.hloc].push(1),o[n.hloc]=[]),o[n.hloc].push(e)});var n=[];for(var e in t)h={},h.hloc=e,h.LatLng=t[e][0],h.pnum=t[e][1],n.push(h);var p=gs.selectAll("circle").data(n).enter().append("circle").style("stroke","black").style("opacity",1).style("fill","green").attr("r",5).on("click",function(t){var n="";o[t.hloc].forEach(function(t,o){let e=person_info[t].psex,p=person_info[t].page,a=person_info[t].hloc,i=person_info[t].pinfo.split(",").join("<br/>-"),r=person_info[t].pno,s=" "==person_info[t].pok?"-":person_info[t].pok,l=person_info[t].pcof,c=person_info[t].pcon,d=person_info[t].ploc;n+="<tr><td>"+r+"</td><td>"+e+"</td><td>"+p+"</td><td>"+c+"</td><td>"+d+"</td><td>"+l+"</td><td>"+a+"</td><td>"+s+"</td><td>"+i+"</td></tr>"}),d3.select("#ttbody").html(n),$("#table-modal").modal("show")}).on("mouseover",function(t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html("<span>격리시설: "+t.hloc+"</span><br><span> 격리인원: "+t.pnum+"인</span>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(t){tooltip.transition().duration(500).style("opacity",0)});function a(){p.attr("transform",function(t){return point=map.project(t.LatLng),"translate("+point.x+","+point.y+")"})}map.on("viewreset",a),map.on("move",a),a()}function myPosition(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){x=t.coords.latitude.toFixed(6),y=t.coords.longitude.toFixed(6),mp=[{LatLng:new mapboxgl.LngLat(y,x)}];var o=mp_g.selectAll("circle").data(mp).enter().append("circle").style("stroke","black").style("opacity",1).style("fill","blue").attr("r",5).on("mouseover",function(t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html("<span>내 위치</span>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(t){tooltip.transition().duration(500).style("opacity",0)});function n(){o.attr("transform",function(t){return point=map.project(t.LatLng),"translate("+point.x+","+point.y+")"})}map.on("viewreset",n),map.on("move",n),n()}):alert("has a pro")}mp_g=svg.append("g"),d3.json("../asset/data/capital.json",function(t,o){var n={},e={};person_info.forEach(function(t,o){t.ploc.replace(" ","")in n?n[t.ploc.replace(" ","")]++:(n[t.ploc.replace(" ","")]=1,e[t.ploc.replace(" ","")]=[]),e[t.ploc.replace(" ","")].push(o)});var p=topojson.object(o,o.objects.skorea_municipalities),a=d3.geo.transform({point:projectPoint}),i=d3.geo.path().projection(a),r=gs.selectAll("path").data(p.geometries).enter().append("path").attr("d",i).attr("class","municipality").style("fill",function(t){return t.properties.locations in n?color(n[t.properties.locations]):""}).on("mouseover",function(t){tooltip.transition().duration(200).style("opacity",.9),pnum=t.properties.locations in n?n[t.properties.locations]:0,tooltip.html("<span>"+t.properties.tag+"</span><br><span> 확진자수: "+pnum+"인</span>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(t){tooltip.transition().duration(500).style("opacity",0)}).on("click",function(t){if(!(t.properties.locations in n))return null;var o="";e[t.properties.locations].forEach(function(t,n){let e=person_info[t].psex,p=person_info[t].page,a=person_info[t].hloc,i=("- "+person_info[t].pinfo).split(",").join("<br/>- "),r=person_info[t].pno,s=" "==person_info[t].pok?"-":person_info[t].pok,l=person_info[t].pcof,c=person_info[t].pcon,d=person_info[t].ploc;o+="<tr><td>"+r+"</td><td>"+e+"</td><td>"+p+"</td><td>"+c+"</td><td>"+d+"</td><td>"+l+"</td><td>"+a+"</td><td>"+s+"</td><td>"+i+"</td></tr>"}),d3.select("#ttbody").html(o),$("#table-modal").modal("show")});function s(){var t=i.bounds(p),o=t[0],n=t[1];svg.attr("width",n[0]-o[0]).attr("height",n[1]-o[1]).style("left",o[0]+"px").style("top",o[1]+"px"),gs.attr("transform","translate("+-o[0]+","+-o[1]+")"),mp_g.attr("transform","translate("+-o[0]+","+-o[1]+")"),r.attr("d",i)}map.on("viewreset",s),map.on("move",s),s(),add_hospital(),myPosition()});